generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String              @id @default(cuid())
  name                      String?
  username                  String?
  email                     String?             @unique
  emailVerified             DateTime?
  image                     String?
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  refreshToken              String?             @unique
  lastLogin                 DateTime?
  lastLimitReset            DateTime?
  currentLimit              Int?
  sampleSubmissionCount     Int                 @default(200)
  lastSampleSubmissionReset DateTime            @default(now())
  rating                    Int?
  rank                      Int?
  totalSampleSubmissions    Int                 @default(0)
  accounts                  Account[]
  ApiKey                    ApiKey[]
  BlogPost                  BlogPost[]
  Comment                   Comment[]
  CommentUpvote             CommentUpvote[]
  PostUpvote                PostUpvote[]
  problems                  Problem[]
  RevokedToken              RevokedToken[]
  SandboxSubmission         SandboxSubmission[]
  Session                   Session[]
  snapshots                 Snapshot[]
  submissions               Submission[]
  workspaces                Workspace[]
  groupMemberships          GroupMember[]
  groupProblemsAdded        GroupProblem[]  @relation("GroupProblemAddedBy")

  @@index([email])
  @@index([createdAt])
  @@index([refreshToken])
}

model Account {
  id                       String   @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  createdAt                DateTime @default(now())
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model RevokedToken {
  id        String   @id @default(cuid())
  jti       String   @unique
  expiresAt DateTime
  reason    String?
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  @@index([jti])
  @@index([expiresAt])
}

model Problem {
  id                 String       @id @default(cuid())
  title              String
  slug               String       @unique
  description        String?
  difficulty         Difficulty
  author             String
  parameters         Json         @default("[]")
  tags               String[]
  baselineBenchmarks Json?        @default("{}")
  definition         String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  userId             String?
  referenceSolution  String?
  getFlops           String?
  User               User?        @relation(fields: [userId], references: [id])
  submissions        Submission[]
  groupProblems      GroupProblem[]

  @@index([author])
  @@index([difficulty])
  @@index([slug])
}

model Submission {
  id               String               @id @default(cuid())
  code             String
  language         String
  status           String?
  runtime          Float?
  memory           Int?
  passedTests      Int?
  totalTests       Int?
  logs             String?
  gpuType          String?
  timeMs           Float?
  memoryMB         Float?
  verified         Boolean              @default(false)
  gflops           Float?
  errorMessage     String?
  errorDetails     String?
  benchmarkResults Json?
  userId           String
  problemId        String
  createdAt        DateTime             @default(now())
  callId           String?
  isPublic         Boolean              @default(false)
  blogPosts        BlogPostSubmission[]
  problem          Problem              @relation(fields: [problemId], references: [id])
  user             User                 @relation(fields: [userId], references: [id])
  testResults      TestResult[]

  @@index([userId])
  @@index([problemId])
  @@index([createdAt])
  @@index([runtime])
}

// Per-test-case results for submissions with detailed GPU metrics
model TestResult {
  id           String         @id @default(cuid())
  submissionId String
  testId       Int // 1-indexed test number
  name         String // Test case name (e.g., "small_128x128")
  avgRuntimeMs Float
  avgGflops    Float?
  runs         BenchmarkRun[]
  submission   Submission     @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId, testId])
  @@index([submissionId])
}

// Individual benchmark iterations with GPU monitoring data
model BenchmarkRun {
  id           String     @id @default(cuid())
  testResultId String
  runIndex     Int // 0-indexed iteration number
  runtimeMs    Float
  gflops       Float?
  gpuSamples   Json // Array of GPUSample objects
  gpuMetrics   Json? // Aggregated GPUMetricsStats
  testResult   TestResult @relation(fields: [testResultId], references: [id], onDelete: Cascade)

  @@unique([testResultId, runIndex])
  @@index([testResultId])
}

model ApiKey {
  id        String   @id @default(cuid())
  userId    String
  name      String
  keyPrefix String   @unique
  key       String
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])

  @@index([expiresAt])
}

model Workspace {
  id        String     @id @default(cuid())
  name      String
  slug      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  files     Json
  main      String
  userId    String
  snapshots Snapshot[]
  user      User       @relation(fields: [userId], references: [id])

  @@unique([slug, userId])
}

model SandboxSubmission {
  id            String   @id @default(cuid())
  code          String
  language      String
  status        String?
  stdout_output String?
  error_message String?
  error_details String?
  logs          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  userId        String
  user          User     @relation(fields: [userId], references: [id])
}

model Snapshot {
  id          String     @id @default(cuid())
  createdAt   DateTime   @default(now())
  files       Json
  main        String
  workspaceId String?
  userId      String
  user        User       @relation(fields: [userId], references: [id])
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])
}

model BlogPost {
  id              String               @id @default(cuid())
  title           String
  content         String
  slug            String?              @unique
  excerpt         String?
  postType        PostType             @default(GENERAL)
  status          PostStatus           @default(DRAFT)
  publishedAt     DateTime?
  viewCount       Int                  @default(0)
  readTimeMinutes Int?
  authorId        String
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  lastAutosaveAt  DateTime?
  author          User                 @relation(fields: [authorId], references: [id], onDelete: Cascade)
  submissions     BlogPostSubmission[]
  tags            BlogPostTag[]
  comments        Comment[]
  revisions       PostRevision[]
  upvotes         PostUpvote[]

  @@index([authorId])
  @@index([createdAt])
  @@index([slug])
  @@index([status])
  @@index([postType])
  @@index([publishedAt])
}

model PostRevision {
  id        String   @id @default(cuid())
  postId    String
  title     String
  content   String
  createdAt DateTime @default(now())
  authorId  String
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Comment {
  id              String          @id @default(cuid())
  postId          String
  authorId        String
  content         String
  parentCommentId String?
  createdAt       DateTime        @default(now())
  author          User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent          Comment?        @relation("Thread", fields: [parentCommentId], references: [id], onDelete: Cascade)
  children        Comment[]       @relation("Thread")
  post            BlogPost        @relation(fields: [postId], references: [id], onDelete: Cascade)
  upvotes         CommentUpvote[]

  @@index([postId, createdAt])
}

model PostUpvote {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId])
}

model CommentUpvote {
  id        String   @id @default(cuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
}

model BlogPostSubmission {
  id           String     @id @default(cuid())
  postId       String
  submissionId String
  order        Int        @default(0)
  description  String?
  createdAt    DateTime   @default(now())
  post         BlogPost   @relation(fields: [postId], references: [id], onDelete: Cascade)
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([postId, submissionId])
  @@index([postId])
  @@index([submissionId])
}

model Tag {
  id          String        @id @default(cuid())
  name        String        @unique
  slug        String        @unique
  description String?
  category    TagCategory   @default(GENERAL)
  createdAt   DateTime      @default(now())
  posts       BlogPostTag[]

  @@index([slug])
  @@index([category])
}

model BlogPostTag {
  id        String   @id @default(cuid())
  postId    String
  tagId     String
  createdAt DateTime @default(now())
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum PostType {
  GENERAL
  SOLUTION
  COMPARISON
  TUTORIAL
  BENCHMARK_ANALYSIS
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum TagCategory {
  GENERAL
  PROBLEM
  LANGUAGE
  OPTIMIZATION
  DIFFICULTY
  TOPIC
}

enum GroupRole {
  OWNER
  ADMIN
  MEMBER
}

model Group {
  id          String         @id @default(cuid())
  name        String
  slug        String         @unique
  description String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  members     GroupMember[]
  problems    GroupProblem[]

  @@index([slug])
}

model GroupMember {
  id       String    @id @default(cuid())
  groupId  String
  userId   String
  role     GroupRole @default(MEMBER)
  joinedAt DateTime  @default(now())
  group    Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

model GroupProblem {
  id        String   @id @default(cuid())
  groupId   String
  problemId String
  addedAt   DateTime @default(now())
  addedById String
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  problem   Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)
  addedBy   User     @relation("GroupProblemAddedBy", fields: [addedById], references: [id])

  @@unique([groupId, problemId])
  @@index([groupId])
  @@index([problemId])
}
